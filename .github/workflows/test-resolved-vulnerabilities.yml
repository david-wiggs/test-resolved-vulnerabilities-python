name: 'Test Resolved Vulnerabilities - Python'

on:
  pull_request:
    branches: [ main ]
  push:
    branches: [ main ]

permissions:
  contents: read
  pull-requests: write

jobs:
  dependency-review:
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    steps:
      - name: 'Checkout Repository'
        uses: actions/checkout@v4
        
      - name: 'Set up Python'
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'
          
      - name: 'Install Dependencies (for context)'
        run: |
          echo "Installing current dependencies..."
          pip install -r requirements.txt
          echo "Installed packages:"
          pip list
        
      - name: 'Dependency Review with Resolved Vulnerabilities'
        id: review
        uses: david-wiggs/dependency-review-action@main
        with:
          fail-on-severity: critical
          comment-summary-in-pr: always
          
      - name: 'Show Resolved Vulnerabilities (Python)'
        if: steps.review.outputs.resolved-vulnerabilities != '[]'
        env:
          RESOLVED_VULNERABILITIES: ${{ steps.review.outputs.resolved-vulnerabilities }}
        run: |
          echo "üêç Python vulnerabilities resolved!"
          echo "Raw JSON output:"
          echo "$RESOLVED_VULNERABILITIES" | jq '.'
          echo ""
          echo "üìä Summary of resolved Python vulnerabilities:"
          echo "$RESOLVED_VULNERABILITIES" | jq -r '.[] | "- \(.severity | ascii_upcase): \(.advisory_summary) in \(.package_name)@\(.package_version)"'
          
      - name: 'No Resolved Vulnerabilities'
        if: steps.review.outputs.resolved-vulnerabilities == '[]'
        run: |
          echo "‚ÑπÔ∏è No Python vulnerabilities were resolved in this change."
          
      - name: 'Python Security Summary'
        run: |
          echo "=== Python Dependency Security Analysis ==="
          echo "Vulnerable changes: ${{ steps.review.outputs.vulnerable-changes }}"
          echo "Resolved vulnerabilities: ${{ steps.review.outputs.resolved-vulnerabilities }}"
          echo "Total dependency changes: ${{ steps.review.outputs.dependency-changes }}"
          
  # Test Python environment setup
  test-app:
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    steps:
      - name: 'Checkout Repository'
        uses: actions/checkout@v4
        
      - name: 'Set up Python'
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'
          
      - name: 'Test Application'
        run: |
          echo "Testing Python application with current dependencies..."
          pip install -r requirements.txt
          python -c "import app; print('‚úÖ App imports successfully')"
          echo "Flask app is ready to run!"